<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Grocery List</title>
  
  <!-- PWA Support -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4CAF50">
  
  <!-- Firebase Configuration -->
  <script src="firebase-config.js"></script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-database-compat.js"></script>
  
  <!-- Cloud Sync Module -->
  <script src="cloud-sync.js"></script>
  
  <style>
    body { 
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    h1 {
      color: #4CAF50;
      text-align: center;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    .form-group {
      margin-bottom: 15px;
    }
    input {
      width: 70%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    button {
      padding: 10px 15px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    ul {
      list-style-type: none;
      padding: 0;
    }
    li {
      background-color: white;
      margin-bottom: 10px;
      padding: 15px;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
    }
    li.checked {
      opacity: 0.6;
      text-decoration: line-through;
    }
    .checkbox {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      border: 2px solid #4CAF50;
      margin-right: 15px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .checkbox.checked:after {
      content: '✓';
      color: #4CAF50;
      font-weight: bold;
    }
    .delete-btn {
      margin-left: auto;
      color: #ff5252;
      font-weight: bold;
      cursor: pointer;
    }
    .status {
      text-align: center;
      margin-bottom: 20px;
      color: #666;
    }
    .nav {
      text-align: center;
      margin-top: 30px;
    }
    .nav a {
      color: #4CAF50;
      text-decoration: none;
      margin: 0 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Grocery List</h1>
    
    <div id="status" class="status">Loading items...</div>
    
    <div class="form-group">
      <input type="text" id="itemInput" placeholder="Add new item...">
      <button id="addButton">Add</button>
    </div>
    
    <ul id="groceryList"></ul>
    
    <div class="nav">
      <a href="index.html">Back to Home</a>
    </div>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Elements
      const statusEl = document.getElementById('status');
      const itemInput = document.getElementById('itemInput');
      const addButton = document.getElementById('addButton');
      const groceryList = document.getElementById('groceryList');
      
      // Variables
      let groceryItems = [];
      
      // Initialize
      init();
      
      function init() {
        // Add event listener for add button
        addButton.addEventListener('click', addItem);
        
        // Add event listener for enter key
        itemInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            addItem();
          }
        });
        
        // Initialize cloud sync
        if (window.cloudSync) {
          statusEl.textContent = 'Connecting to sync service...';
          
          cloudSync.init()
            .then(() => {
              statusEl.textContent = 'Connected! Loading items...';
              
              // Check if user is logged in
              const currentUser = cloudSync.getCurrentUser();
              
              if (currentUser.email && currentUser.shareCode) {
                loadItems();
              } else {
                statusEl.textContent = 'Please log in to sync your grocery list.';
                loadLocalItems();
              }
            })
            .catch(error => {
              console.error('Error initializing cloud sync:', error);
              statusEl.textContent = 'Error connecting to sync service. Using local storage.';
              loadLocalItems();
            });
        } else {
          statusEl.textContent = 'Sync service not available. Using local storage.';
          loadLocalItems();
        }
      }
      
      function loadItems() {
        const currentUser = cloudSync.getCurrentUser();
        
        cloudSync.getSharedLists()
          .then(lists => {
            if (!lists[currentUser.shareCode]) {
              // Create a new list if it doesn't exist
              statusEl.textContent = 'Creating new grocery list...';
              const newList = {
                owner: currentUser.email,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                items: []
              };
              
              return cloudSync.saveSharedList(currentUser.shareCode, newList)
                .then(() => {
                  groceryItems = [];
                  renderItems();
                  statusEl.textContent = 'New grocery list created!';
                });
            } else {
              // Use existing list
              const listData = lists[currentUser.shareCode];
              groceryItems = listData.items || [];
              renderItems();
              statusEl.textContent = groceryItems.length > 0 
                ? `${groceryItems.length} item${groceryItems.length !== 1 ? 's' : ''} in your list` 
                : 'Your grocery list is empty. Add some items!';
            }
          })
          .catch(error => {
            console.error('Error loading items:', error);
            statusEl.textContent = 'Error loading items. Using local storage.';
            loadLocalItems();
          });
      }
      
      function loadLocalItems() {
        try {
          const savedItems = localStorage.getItem('groceryItems');
          if (savedItems) {
            groceryItems = JSON.parse(savedItems);
          } else {
            groceryItems = [];
          }
          renderItems();
          statusEl.textContent = groceryItems.length > 0 
            ? `${groceryItems.length} item${groceryItems.length !== 1 ? 's' : ''} in your list (local)` 
            : 'Your grocery list is empty. Add some items!';
        } catch (error) {
          console.error('Error loading local items:', error);
          groceryItems = [];
          renderItems();
          statusEl.textContent = 'Error loading local items.';
        }
      }
      
      function saveItems() {
        statusEl.textContent = 'Saving...';
        
        const currentUser = cloudSync.getCurrentUser();
        
        if (currentUser.email && currentUser.shareCode) {
          // Save to cloud
          cloudSync.getSharedLists()
            .then(lists => {
              let listData = lists[currentUser.shareCode];
              
              if (!listData) {
                listData = {
                  owner: currentUser.email,
                  createdAt: new Date().toISOString(),
                  shareCode: currentUser.shareCode
                };
              }
              
              listData.items = groceryItems;
              listData.updatedAt = new Date().toISOString();
              
              return cloudSync.saveSharedList(currentUser.shareCode, listData);
            })
            .then(() => {
              statusEl.textContent = 'List saved to cloud!';
              saveLocalItems(); // Also save locally as backup
            })
            .catch(error => {
              console.error('Error saving to cloud:', error);
              statusEl.textContent = 'Error saving to cloud. Saved locally.';
              saveLocalItems();
            });
        } else {
          // Save locally only
          saveLocalItems();
        }
      }
      
      function saveLocalItems() {
        try {
          localStorage.setItem('groceryItems', JSON.stringify(groceryItems));
          if (!cloudSync.getCurrentUser().email) {
            statusEl.textContent = 'List saved locally!';
          }
        } catch (error) {
          console.error('Error saving locally:', error);
          statusEl.textContent = 'Error saving locally.';
        }
      }
      
      function renderItems() {
        groceryList.innerHTML = '';
        
        groceryItems.forEach((item, index) => {
          const li = document.createElement('li');
          if (item.checked) {
            li.classList.add('checked');
          }
          
          const checkbox = document.createElement('div');
          checkbox.className = 'checkbox';
          if (item.checked) {
            checkbox.classList.add('checked');
          }
          checkbox.addEventListener('click', () => toggleItem(index));
          
          const text = document.createElement('span');
          text.textContent = item.text;
          text.addEventListener('click', () => toggleItem(index));
          
          const deleteBtn = document.createElement('span');
          deleteBtn.className = 'delete-btn';
          deleteBtn.textContent = '✕';
          deleteBtn.addEventListener('click', () => deleteItem(index));
          
          li.appendChild(checkbox);
          li.appendChild(text);
          li.appendChild(deleteBtn);
          groceryList.appendChild(li);
        });
      }
      
      function addItem() {
        const text = itemInput.value.trim();
        if (!text) return;
        
        groceryItems.push({
          text,
          checked: false,
          createdAt: new Date().toISOString()
        });
        
        saveItems();
        renderItems();
        
        itemInput.value = '';
        itemInput.focus();
      }
      
      function toggleItem(index) {
        groceryItems[index].checked = !groceryItems[index].checked;
        saveItems();
        renderItems();
      }
      
      function deleteItem(index) {
        groceryItems.splice(index, 1);
        saveItems();
        renderItems();
      }
    });
  </script>
</body>
</html> 